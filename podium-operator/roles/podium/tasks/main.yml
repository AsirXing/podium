---
- name: Deploy etherpad
  k8s:
    definition:
      kind: Deployment
      apiVersion: apps/v1
      metadata:
        name: etherpad
        namespace: '{{ meta.namespace }}'
        labels:
          app: "{{APPLICATION_NAME}}"
      spec:
        replicas: "{{size}}"
        strategy:
          type: RollingUpdate
        selector:
          matchLabels:
            app: "{{APPLICATION_NAME}}"
        template:
          metadata:
            labels:
              app: "{{APPLICATION_NAME}}"
              name: etherpad
          spec:
            containers:
            - env:
              - name: TITLE
                value: "{{ETHERPAD_DEFAULT_TITLE}}"
              - name: DEFAULT_PAD_TEXT
                value: "{{ETHERPAD_DEFAULT_TEXT}}"
              image: etherpad/etherpad
              imagePullPolicy: Always
              name: etherpad
              readinessProbe:
                httpGet:
                  path: /
                  port: 9001
                initialDelaySeconds: 60
                periodSeconds: 10
                timeoutSeconds: 60
              livenessProbe:
                httpGet:
                  path: /
                  port: 9001
                initialDelaySeconds: 120
                periodSeconds: 10
              ports:
              - containerPort: 9001
            restartPolicy: Always
        triggers:
        - type: ConfigChange
- name: Deploy etherpad service
  k8s:
    definition:
      apiVersion: v1
      kind: Service
      metadata:
        namespace: '{{ meta.namespace }}'
        labels:
          app: "{{APPLICATION_NAME}}"
        name: etherpad
      spec:
        ports:
        - port: 9001
          targetPort: 9001
        selector:
          app: "{{APPLICATION_NAME}}"
          name: etherpad
      status:
        loadBalancer: {}
- name: Deploy etherpad route
  k8s:
    definition:
      apiVersion: route.openshift.io/v1
      kind: Route
      metadata:
        namespace: '{{ meta.namespace }}'
        annotations:
          openshift.io/host.generated: "true"
          kubernetes.io/tls-acme: "true"
        name: etherpad
      spec:
        host: "{{APPLICATION_DOMAIN}}"
        port:
          targetPort: 9001
        tls:
          termination: edge
        to:
          kind: Service
          name: etherpad
          weight: 100
        wildcardPolicy: None
